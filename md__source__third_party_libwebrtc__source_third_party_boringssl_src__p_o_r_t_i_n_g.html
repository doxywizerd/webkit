<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>webkit: Porting from OpenSSL to BoringSSL</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">webkit
   &#160;<span id="projectnumber">2cdf99a9e3038c7e01b3c37e8ad903ecbe5eecf1</span>
   </div>
   <div id="projectbrief">https://github.com/WebKit/webkit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Porting from OpenSSL to BoringSSL </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>BoringSSL is an OpenSSL derivative and is mostly source-compatible, for the subset of OpenSSL retained. Libraries ideally need little to no changes for BoringSSL support, provided they do not use removed APIs. In general, see if the library compiles and, on failure, consult the documentation in the header files and see if problematic features can be removed.</p>
<p>In some cases, BoringSSL-specific code may be necessary. In that case, the <code>OPENSSL_IS_BORINGSSL</code> preprocessor macro may be used in <code>#ifdef</code>s. This macro should also be used in lieu of the presence of any particular function to detect OpenSSL vs BoringSSL in configure scripts, etc., where those are necessary. Before using the preprocessor, however, contact the BoringSSL maintainers about the missing APIs. If not an intentionally removed feature, BoringSSL will typically add compatibility functions for convenience.</p>
<p>For convenience, BoringSSL defines upstream's <code>OPENSSL_NO_*</code> feature macros corresponding to removed features. These may also be used to disable code which uses a removed feature.</p>
<p>Note: BoringSSL does <em>not</em> have a stable <a class="el" href="namespace_a_p_i.html">API</a> or ABI. It must be updated with its consumers. It is not suitable for, say, a system library in a traditional Linux distribution. For instance, Chromium statically links the specific revision of BoringSSL it was built against. Likewise, Android's system-internal copy of BoringSSL is not exposed by the NDK and must not be used by third-party applications.</p>
<h2>Major <a class="el" href="namespace_a_p_i.html">API</a> changes</h2>
<h3>Integer types</h3>
<p>Some APIs have been converted to use <code>size_t</code> for consistency and to avoid integer overflows at the <a class="el" href="namespace_a_p_i.html">API</a> boundary. (Existing logic uses a mismash of <code>int</code>, <code>long</code>, and <code>unsigned</code>.) For the most part, implicit casts mean that existing code continues to compile. In some cases, this may require BoringSSL-specific code, particularly to avoid compiler warnings.</p>
<p>Most notably, the <code><a class="el" href="libwebrtc_2_source_2third__party_2boringssl_2src_2include_2openssl_2stack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF(T)</a></code> types have all been converted to use <code>size_t</code> instead of <code>int</code> for indices and lengths.</p>
<h3>Reference counts</h3>
<p>Some external consumers increment reference counts directly by calling <code>CRYPTO_add</code> with the corresponding <code>CRYPTO_LOCK_*</code> value.</p>
<p>These APIs no longer exist in BoringSSL. Instead, code which increments reference counts should call the corresponding <code>FOO_up_ref</code> function, such as <code>EVP_PKEY_up_ref</code>. Note that not all of these APIs are present in OpenSSL and may require <code>#ifdef</code>s.</p>
<h3>Error codes</h3>
<p>OpenSSL's errors are extremely specific, leaking internals of the library, including even a function code for the function which emitted the error! As some logic in BoringSSL has been rewritten, code which conditions on the error may break (grep for <code>ERR_GET_REASON</code> and <code>ERR_GET_FUNC</code>). This danger also exists when upgrading OpenSSL versions.</p>
<p>Where possible, avoid conditioning on the exact error reason. Otherwise, a BoringSSL <code>#ifdef</code> may be necessary. Exactly how best to resolve this issue is still being determined. It's possible some new APIs will be added in the future.</p>
<p>Function codes have been completely removed. Remove code which conditions on these as it will break with the slightest change in the library, OpenSSL or BoringSSL.</p>
<h3><code>*_ctrl</code> functions</h3>
<p>Some OpenSSL APIs are implemented with <code>ioctl</code>-style functions such as <code>SSL_ctrl</code> and <code>EVP_PKEY_CTX_ctrl</code>, combined with convenience macros, such as </p><pre class="fragment"># define SSL_CTX_set_mode(ctx,op) \
        SSL_CTX_ctrl((ctx),SSL_CTRL_MODE,(op),NULL)
</pre><p>In BoringSSL, these macros have been replaced with proper functions. <a class="el" href="protocol_the-p.html">The</a> underlying <code>_ctrl</code> functions have been removed.</p>
<p>For convenience, <code>SSL_CTRL_*</code> values are retained as macros to <code>doesnt_exist</code> so existing code which uses them (or the wrapper macros) in <code>#ifdef</code> expressions will continue to function. However, the macros themselves will not work.</p>
<p>Switch any <code>*_ctrl</code> callers to the macro/function versions. This works in both OpenSSL and BoringSSL. Note that BoringSSL's function versions will be type-checked and may require more care with types. See the end of this document for a table of functions to use.</p>
<h3>HMAC <code>EVP_PKEY</code>s</h3>
<p><code>EVP_PKEY_HMAC</code> is removed. Use the <code>HMAC_*</code> functions in <code>hmac.h</code> instead. This is compatible with OpenSSL.</p>
<h3>DSA <code>EVP_PKEY</code>s</h3>
<p><code>EVP_PKEY_DSA</code> is deprecated. It is currently still possible to parse DER into a DSA <code>EVP_PKEY</code>, but signing or verifying with those objects will not work.</p>
<h3>DES</h3>
<p><a class="el" href="protocol_the-p.html">The</a> <code>DES_cblock</code> type has been switched from an array to a struct to avoid the pitfalls around array types in <a class="el" href="class_c.html">C</a>. Where features which require DES cannot be disabled, BoringSSL-specific codepaths may be necessary.</p>
<h3>TLS renegotiation</h3>
<p>OpenSSL enables TLS renegotiation by default and accepts renegotiation requests from the peer transparently. Renegotiation is an extremely problematic protocol feature, so BoringSSL rejects peer renegotiations by default.</p>
<p>To enable renegotiation, call <code>SSL_set_renegotiate_mode</code> and set it to <code>ssl_renegotiate_once</code> or <code>ssl_renegotiate_freely</code>. Renegotiation is only supported as a client in SSL3/TLS and the HelloRequest must be received at a quiet point in the application protocol. This is sufficient to support the common use of requesting a new client certificate between an HTTP request and response in (unpipelined) HTTP/1.1.</p>
<p>Things which do not work:</p>
<ul>
<li>There is no support for renegotiation as a server.</li>
<li>There is no support for renegotiation in DTLS.</li>
<li>There is no support for initiating renegotiation; <code>SSL_renegotiate</code> always fails and <code>SSL_set_state</code> does nothing.</li>
<li>Interleaving application data with the new handshake is forbidden.</li>
<li>If a HelloRequest is received while <code>SSL_write</code> has unsent application data, the renegotiation is rejected.</li>
</ul>
<h3>Lowercase hexadecimal</h3>
<p>BoringSSL's <code>BN_bn2hex</code> function uses lowercase hexadecimal digits instead of uppercase. Some code may require changes to avoid being sensitive to this difference.</p>
<h3>Legacy ASN.1 functions</h3>
<p>OpenSSL's ASN.1 stack uses <code>d2i</code> functions for parsing. They have the form: </p><pre class="fragment">RSA *d2i_RSAPrivateKey(RSA **out, const uint8_t **inp, long len);
</pre><p>In addition to returning the result, OpenSSL places it in <code>*out</code> if <code>out</code> is not <code>NULL</code>. On input, if <code>*out</code> is not <code>NULL</code>, OpenSSL will usually (but not always) reuse that object rather than allocating a new one. In BoringSSL, these functions are compatibility wrappers over a newer ASN.1 stack. Even if <code>*out</code> is not <code>NULL</code>, these wrappers will always allocate a new object and free the previous one.</p>
<p>Ensure that callers do not rely on this object reuse behavior. It is recommended to avoid the <code>out</code> parameter completely and always pass in <code>NULL</code>. Note that less error-prone APIs are available for BoringSSL-specific code (see below).</p>
<h2><a class="el" href="struct_optional.html">Optional</a> BoringSSL-specific simplifications</h2>
<p>BoringSSL makes some changes to OpenSSL which simplify the <a class="el" href="namespace_a_p_i.html">API</a> but remain compatible with OpenSSL consumers. In general, consult the BoringSSL documentation for any functions in new BoringSSL-only code.</p>
<h3>Return values</h3>
<p>Most OpenSSL APIs return 1 on success and either 0 or -1 on failure. BoringSSL has narrowed most of these to 1 on success and 0 on failure. BoringSSL-specific code may take advantage of the less error-prone APIs and use <code>!</code> to check for errors.</p>
<h3>Initialization</h3>
<p>OpenSSL has a number of different initialization functions for setting up error strings and loading algorithms, etc. All of these functions still exist in BoringSSL for convenience, but they do nothing and are not necessary.</p>
<p><a class="el" href="protocol_the-p.html">The</a> one exception is <code>CRYPTO_library_init</code>. In <code>BORINGSSL_NO_STATIC_INITIALIZER</code> builds, it must be called to query CPU capabitilies before the rest of the library. In the default configuration, this is done with a static initializer and is also unnecessary.</p>
<h3>Threading</h3>
<p>OpenSSL provides a number of APIs to configure threading callbacks and set up locks. Without initializing these, the library is not thread-safe. Configuring these does nothing in BoringSSL. Instead, BoringSSL calls pthreads and the corresponding Windows APIs internally and is always thread-safe where the <a class="el" href="namespace_a_p_i.html">API</a> guarantees it.</p>
<h3>ASN.1</h3>
<p>BoringSSL is in the process of deprecating OpenSSL's <code>d2i</code> and <code>i2d</code> in favor of new functions using the much less error-prone <code>CBS</code> and <code>CBB</code> types. BoringSSL-only code should use those functions where available.</p>
<h2>Replacements for <code>CTRL</code> values</h2>
<p>When porting code which uses <code>SSL_CTX_ctrl</code> or <code>SSL_ctrl</code>, use the replacement functions below. If a function has both <code>SSL_CTX</code> and <code>SSL</code> variants, only the <code>SSL_CTX</code> version is listed.</p>
<p>Note some values correspond to multiple functions depending on the <code>larg</code> parameter.</p>
<table class="doxtable">
<tr>
<th><code>CTRL</code> value </th><th>Replacement function(s)  </th></tr>
<tr>
<td><code>DTLS_CTRL_GET_TIMEOUT</code> </td><td><code>DTLSv1_get_timeout</code> </td></tr>
<tr>
<td><code>DTLS_CTRL_HANDLE_TIMEOUT</code> </td><td><code>DTLSv1_handle_timeout</code> </td></tr>
<tr>
<td><code>SSL_CTRL_CHAIN</code> </td><td><code>SSL_CTX_set0_chain</code> or <code>SSL_CTX_set1_chain</code> </td></tr>
<tr>
<td><code>SSL_CTRL_CHAIN_CERT</code> </td><td><code>SSL_add0_chain_cert</code> or <code>SSL_add1_chain_cert</code> </td></tr>
<tr>
<td><code>SSL_CTRL_CLEAR_EXTRA_CHAIN_CERTS</code> </td><td><code>SSL_CTX_clear_extra_chain_certs</code> </td></tr>
<tr>
<td><code>SSL_CTRL_CLEAR_MODE</code> </td><td><code>SSL_CTX_clear_mode</code> </td></tr>
<tr>
<td><code>SSL_CTRL_CLEAR_OPTIONS</code> </td><td><code>SSL_CTX_clear_options</code> </td></tr>
<tr>
<td><code>SSL_CTRL_EXTRA_CHAIN_CERT</code> </td><td><code>SSL_CTX_add_extra_chain_cert</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_CHAIN_CERTS</code> </td><td><code>SSL_CTX_get0_chain_certs</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_CLIENT_CERT_TYPES</code> </td><td><code>SSL_get0_certificate_types</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_EXTRA_CHAIN_CERTS</code> </td><td><code>SSL_CTX_get_extra_chain_certs</code> or <code>SSL_CTX_get_extra_chain_certs_only</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_MAX_CERT_LIST</code> </td><td><code>SSL_CTX_get_max_cert_list</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_NUM_RENEGOTIATIONS</code> </td><td><code>SSL_num_renegotiations</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_READ_AHEAD</code> </td><td><code>SSL_CTX_get_read_ahead</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_RI_SUPPORT</code> </td><td><code>SSL_get_secure_renegotiation_support</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_SESSION_REUSED</code> </td><td><code>SSL_session_reused</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_SESS_CACHE_MODE</code> </td><td><code>SSL_CTX_get_session_cache_mode</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_SESS_CACHE_SIZE</code> </td><td><code>SSL_CTX_sess_get_cache_size</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_TLSEXT_TICKET_KEYS</code> </td><td><code>SSL_CTX_get_tlsext_ticket_keys</code> </td></tr>
<tr>
<td><code>SSL_CTRL_GET_TOTAL_RENEGOTIATIONS</code> </td><td><code>SSL_total_renegotiations</code> </td></tr>
<tr>
<td><code>SSL_CTRL_MODE</code> </td><td><code>SSL_CTX_get_mode</code> or <code>SSL_CTX_set_mode</code> </td></tr>
<tr>
<td><code>SSL_CTRL_NEED_TMP_RSA</code> </td><td><code>SSL_CTX_need_tmp_RSA</code> is equivalent, but <a href="https://freakattack.com/"><em>do not use this function</em></a>. (It is a no-op in BoringSSL.) </td></tr>
<tr>
<td><code>SSL_CTRL_OPTIONS</code> </td><td><code>SSL_CTX_get_options</code> or <code>SSL_CTX_set_options</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SESS_NUMBER</code> </td><td><code>SSL_CTX_sess_number</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_CURVES</code> </td><td><code>SSL_CTX_set1_curves</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_MAX_CERT_LIST</code> </td><td><code>SSL_CTX_set_max_cert_list</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_MAX_SEND_FRAGMENT</code> </td><td><code>SSL_CTX_set_max_send_fragment</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_MSG_CALLBACK</code> </td><td><code>SSL_set_msg_callback</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_MSG_CALLBACK_ARG</code> </td><td><code>SSL_set_msg_callback_arg</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_MTU</code> </td><td><code>SSL_set_mtu</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_READ_AHEAD</code> </td><td><code>SSL_CTX_set_read_ahead</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_SESS_CACHE_MODE</code> </td><td><code>SSL_CTX_set_session_cache_mode</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_SESS_CACHE_SIZE</code> </td><td><code>SSL_CTX_sess_set_cache_size</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TLSEXT_HOSTNAME</code> </td><td><code>SSL_set_tlsext_host_name</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TLSEXT_SERVERNAME_ARG</code> </td><td><code>SSL_CTX_set_tlsext_servername_arg</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TLSEXT_SERVERNAME_CB</code> </td><td><code>SSL_CTX_set_tlsext_servername_callback</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TLSEXT_TICKET_KEYS</code> </td><td><code>SSL_CTX_set_tlsext_ticket_keys</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TLSEXT_TICKET_KEY_CB</code> </td><td><code>SSL_CTX_set_tlsext_ticket_key_cb</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TMP_DH</code> </td><td><code>SSL_CTX_set_tmp_dh</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TMP_DH_CB</code> </td><td><code>SSL_CTX_set_tmp_dh_callback</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TMP_ECDH</code> </td><td><code>SSL_CTX_set_tmp_ecdh</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TMP_ECDH_CB</code> </td><td><code>SSL_CTX_set_tmp_ecdh_callback</code> </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TMP_RSA</code> </td><td><code>SSL_CTX_set_tmp_rsa</code> is equivalent, but <a href="https://freakattack.com/"><em>do not use this function</em></a>. (It is a no-op in BoringSSL.) </td></tr>
<tr>
<td><code>SSL_CTRL_SET_TMP_RSA_CB</code> </td><td><code>SSL_CTX_set_tmp_rsa_callback</code> is equivalent, but <a href="https://freakattack.com/"><em>do not use this function</em></a>. (It is a no-op in BoringSSL.) </td></tr>
</table>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
