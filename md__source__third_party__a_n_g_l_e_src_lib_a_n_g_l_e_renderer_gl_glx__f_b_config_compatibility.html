<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>webkit: GLX Framebuffer Compatibility investigation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">webkit
   &#160;<span id="projectnumber">2cdf99a9e3038c7e01b3c37e8ad903ecbe5eecf1</span>
   </div>
   <div id="projectbrief">https://github.com/WebKit/webkit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">GLX Framebuffer Compatibility investigation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In GLX and EGL, contexts are created with respect to a config that describes the type of surfaces they will be used to render to. Likewise surfaces are created with respect to a config and for a context to be able to render to a surface, both their configs must be compatible. Compatibility is losely described in both the GLX and EGL specs but the following is clear:</p><ul>
<li>In GLX the config's color buffer must have the same type, including RGBA vs. ColorIndex and the buffers must have the same depth, if they exist.</li>
<li>In EGL the config's color buffer must have the same type and the buffers must have the same depth (not clear if it is only if they exist)</li>
</ul>
<p>Obviously the EGLconfig we will expose will have a one-to-one correspondance with GLXFBConfigs.</p>
<p>Our EGL implementation uses a single OpenGL context to back all the EGLcontexts created by the application. Since our GL context and GLXContext are the same object but in two APIs, we will make the confusion and call the GLX context our backing context.</p>
<p><a class="el" href="protocol_the-p.html">The</a> problem we have is that the the GLX context is created before the application can choose what type of context it wants to use, that means we have to expose EGLconfigs whose respective GLXFBConfigs are compatible with the GLXFBConfig of our GLX context; we also need to choose the GLXFBConfig of our GLX context so that it matches the most common needs of application.</p>
<h2>Choice of the GLX context GLXFBConfig </h2>
<p>We decided that our GLX context's configuration must satisfy the following:</p><ul>
<li>Have a RGBA8 color buffer and D24S8 depth-stencil buffer which is what the vast majority of applications use.</li>
<li>It must render in direct colors, i.e. not in a color indexed format.</li>
<li>It must be double-buffered (see later)</li>
<li>It must support rendering to all the types of GLX surfaces so that we can use it for all types of EGL surfaces</li>
<li>It must have an associated visual ID so that we can use it with X, it seems like this would be strongly tied to it having the <code>WINDOW_BIT</code> set.</li>
<li>We would like a conformant context.</li>
</ul>
<h2>Study of compatible GLXFBConfigs </h2>
<p>When using the condition of compatibility defined in the GLX spec and filtering out the non-conformant GLXFBConfig we got the following list (see function </p><div class="fragment"><div class="line">{print_visual_attribs_short```}</div><div class="line">to understand how to read the table):</div></div><!-- fragment --><p> visual x bf lv rg d st colorbuffer sr ax dp st accumbuffer ms cav </p><h2>id dep cl sp sz l ci b ro r g b a <a class="el" href="class_f.html">F</a> gb bf th cl r g b a ns b eat Result </h2>
<p>0x02e 24 tc 0 32 0 r . . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Fail 0x0e4 32 tc 0 32 0 r . . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None BadMatch 0x02c 24 tc 0 32 0 r y . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Pass 0x0e2 32 tc 0 32 0 r y . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None BadMatch 0x089 24 dc 0 32 0 r . . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Fail 0x087 24 dc 0 32 0 r y . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Pass 0x026 24 tc 0 32 0 r . . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Fail 0x0dc 32 tc 0 32 0 r . . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None BadMatch 0x024 24 tc 0 32 0 r y . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Pass 0x0da 32 tc 0 32 0 r y . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None BadMatch 0x081 24 dc 0 32 0 r . . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Fail 0x07f 24 dc 0 32 0 r y . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Pass </p><div class="fragment"><div class="line">The last column shows the result of trying to render on a window using the config,</div><div class="line">with a GLX context using config 0x024. The first thing we see is that BadMatch is</div><div class="line">thrown by the X server when creating the subwindow for rendering. This was because</div><div class="line">we didn&#39;t set the border pixel of the subwindow *shake fist at X11* (see this [StackOverflow question](http://stackoverflow.com/questions/3645632/how-to-create-a-window-with-a-bit-depth-of-32)).</div><div class="line">The result updated with this fix give:</div></div><!-- fragment --><p> visual x bf lv rg d st colorbuffer sr ax dp st accumbuffer ms cav </p><h2>id dep cl sp sz l ci b ro r g b a <a class="el" href="class_f.html">F</a> gb bf th cl r g b a ns b eat </h2>
<p>0x02e 24 tc 0 32 0 r . . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Fail 0x0e4 32 tc 0 32 0 r . . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Fail 0x02c 24 tc 0 32 0 r y . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Pass 0x0e2 32 tc 0 32 0 r y . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Pass 0x089 24 dc 0 32 0 r . . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Fail 0x087 24 dc 0 32 0 r y . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None Pass 0x026 24 tc 0 32 0 r . . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Fail 0x0dc 32 tc 0 32 0 r . . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Fail 0x024 24 tc 0 32 0 r y . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Pass 0x0da 32 tc 0 32 0 r y . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Pass 0x081 24 dc 0 32 0 r . . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Fail 0x07f 24 dc 0 32 0 r y . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None Pass </p><div class="fragment"><div class="line">From this we see that our rendering test passed if and only if the config was double</div><div class="line">buffered like 0x024 which is our GLX context config. The compatible configs are then:</div></div><!-- fragment --><p> visual x bf lv rg d st colorbuffer sr ax dp st accumbuffer ms cav </p><h2>id dep cl sp sz l ci b ro r g b a <a class="el" href="class_f.html">F</a> gb bf th cl r g b a ns b eat </h2>
<p>0x02c 24 tc 0 32 0 r y . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None 0x0e2 32 tc 0 32 0 r y . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None 0x087 24 dc 0 32 0 r y . 8 8 8 8 . s 4 0 0 16 16 16 16 0 0 None 0x024 24 tc 0 32 0 r y . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None 0x0da 32 tc 0 32 0 r y . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None 0x07f 24 dc 0 32 0 r y . 8 8 8 8 . s 4 24 8 16 16 16 16 0 0 None </p><div class="fragment"><div class="line">We can see two dimensions, with our without a depth-stencil buffer and with TrueColor</div><div class="line">or DirectColor. The depth-stencil will be useful to expose to application.</div><div class="line"></div><div class="line">More on double buffering</div><div class="line">------------------------</div><div class="line">The tests above show that double-buffered contexts are not compatible with single-</div><div class="line">buffered surfaces; however other tests show that single-buffered contexts are</div><div class="line">compatible with both single and double-buffered surfaces. The problem is that in</div><div class="line">that case, we can see some flickering even with double-buffered surfaces. If we</div><div class="line">can find a trick to avoid that flicker, then we would be able to expose single</div><div class="line">and double-buffered surfaces at the EGL level. Not exposing them isn&#39;t too much</div><div class="line">of a problem though as the vast majority of application want double-buffering.</div><div class="line"></div><div class="line">AMD and extra buffers</div><div class="line">---------------------</div><div class="line">As can be seen above, NVIDIA does not expose conformant context with multisampled</div><div class="line">buffers or non RGBA16 accumulation buffers. The behavior is different on AMD that</div><div class="line">exposes them as conformant, which gives the following list after filtering as</div><div class="line">explained above:</div></div><!-- fragment --><p> visual x bf lv rg d st colorbuffer sr ax dp st accumbuffer ms cav </p><h2>id dep cl sp sz l ci b ro r g b a <a class="el" href="class_f.html">F</a> gb bf th cl r g b a ns b eat </h2>
<p>0x023 24 tc 0 32 0 r y . 8 8 8 8 . . 0 24 8 16 16 16 16 0 0 None 0x027 24 tc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None 0x02b 24 tc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 2 1 None 0x02f 24 tc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 4 1 None 0x03b 24 dc 0 32 0 r y . 8 8 8 8 . . 0 24 8 16 16 16 16 0 0 None 0x03f 24 dc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None 0x043 24 dc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 2 1 None 0x047 24 dc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 4 1 None </p><div class="fragment"><div class="line">ANGLE&#39;s context is created using 0x027 and experimentation shows it is only compatible</div><div class="line">with 0x03f which is the only other config lacking both an accumulation buffer and a</div><div class="line">multisample buffer. The GLX spec seems to hint it should still work (&quot;should have the</div><div class="line">same size, if they exist&quot;) but it doesn&#39;t work in this case. Filtering the configs to</div><div class="line">have the same multisample and accumulation buffers gives the following:</div></div><!-- fragment --><p> visual x bf lv rg d st colorbuffer sr ax dp st accumbuffer ms cav </p><h2>id dep cl sp sz l ci b ro r g b a <a class="el" href="class_f.html">F</a> gb bf th cl r g b a ns b eat </h2>
<p>0x027 24 tc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None 0x03f 24 dc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None </p><div class="fragment"><div class="line">Mesa Intel driver</div><div class="line">-----------------</div><div class="line">In GLX, a criterium for context and surface compatibility is that buffers</div><div class="line">should have the same depth, if they exist at all in the surface. This means</div><div class="line">that it should be possible to make a context with a D24S8 depth-stencil</div><div class="line">buffer to a surface without a depth-stencil buffer. This doesn&#39;t work on the</div><div class="line">Mesa Intel driver. The list before the workaround was the following, with</div><div class="line">0x020 being the fbconfig chosen for the context:</div></div><!-- fragment --><p> visual x bf lv rg d st colorbuffer sr ax dp st accumbuffer ms cav </p><h2>id dep cl sp sz l ci b ro r g b a <a class="el" href="class_f.html">F</a> gb bf th cl r g b a ns b eat </h2>
<p>0x020 24 tc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None 0x021 24 dc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None 0x08f 32 tc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None 0x0d0 24 tc 0 32 0 r y . 8 8 8 8 . . 0 0 0 0 0 0 0 0 0 None 0x0e2 24 dc 0 32 0 r y . 8 8 8 8 . . 0 0 0 0 0 0 0 0 0 None 0x0e9 24 dc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None </p><div class="fragment"><div class="line">After the workaround that list becomes the following:</div></div><!-- fragment --><p> visual x bf lv rg d st colorbuffer sr ax dp st accumbuffer ms cav </p><h2>id dep cl sp sz l ci b ro r g b a <a class="el" href="class_f.html">F</a> gb bf th cl r g b a ns b eat </h2>
<p>0x020 24 tc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None 0x021 24 dc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None 0x08f 32 tc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None 0x0e9 24 dc 0 32 0 r y . 8 8 8 8 . . 0 24 8 0 0 0 0 0 0 None ```</p>
<h2>Future investigation </h2>
<p>All the non-conformant configs have a multisampled buffer, so it could be interesting to see if we can use them to expose another EGL extension.</p>
<p>Finally this document is written with respect to a small number of drivers, before using the GLX EGL implementation in the wild it would be good to test it on other drivers and hardware.</p>
<p><a class="el" href="protocol_the-p.html">The</a> drivers tested were:</p>
<ul>
<li>the proprietary NVIDIA driver</li>
<li>the proprietary AMD driver</li>
<li>the open source Intel (Broadwell) Mesa driver </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
