<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>webkit: Writing Complex Tests</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">webkit
   &#160;<span id="projectnumber">2cdf99a9e3038c7e01b3c37e8ad903ecbe5eecf1</span>
   </div>
   <div id="projectbrief">https://github.com/WebKit/webkit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Writing Complex Tests </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>For many tests, writing one or more static HTML files is sufficient. However there are a large class of tests for which this approach is insufficient, including:</p>
<ul>
<li>Tests that require cross-domain access</li>
<li>Tests that depend on setting specific headers or status codes</li>
<li>Tests that need to inspect the browser sent request</li>
<li>Tests that require state to be stored on the server</li>
<li>Tests that require precise timing of the response.</li>
</ul>
<p>To make writing such tests possible, we are using a number of server-side components designed to make it easy to manipulate the precise details of the response:</p>
<ul>
<li><em>wptserve</em>, a custom python HTTP server.</li>
<li><em>pywebsocket</em>, an existing websockets server</li>
</ul>
<p>This document will concentrate on the features of wptserve available to test authors.</p>
<h2>Introduction to wptserve</h2>
<p>wptserve is a python-based web server. By default it serves static files in the testsuite. For more sophisticated requirements, several mechanisms are available to take control of the response. These are outlined below.</p>
<h2>Pipes</h2>
<p>Suitable for:</p>
<ul>
<li>Cross domain requests</li>
<li>Adding headers or status codes to static files</li>
<li>Controlling the sending of static file bodies</li>
</ul>
<p>Pipes are designed to allow simple manipulation of the way that static files are sent without requiring any custom code. They are also useful for cross-origin tests because they can be used to activate a substitution mechanism which can fill in details of ports and server names in the setup on which the tests are being run.</p>
<p>Pipes are indicated by adding a query string to a request for a static resource, with the parameter name <code>pipe</code>. <a class="el" href="protocol_the-p.html">The</a> value of the query should be a <code>|</code> serperated list of pipe functions. For example to return a <code>.html</code> file with the status code 410 and a Content-Type of text/plain, one might use: </p><pre class="fragment">/resources/example.html?pipe=status(410)|header(Content-Type,text/plain)
</pre><p>There are a selection of pipe functions provided with wptserve and more may be added if there are good use cases.</p>
<h3>sub</h3>
<p>Used to subsitute variables from the server environment, or from the request into the response. <a class="el" href="struct_a.html">A</a> typical use case is for testing cross-domain since the exact domain name and ports of the servers are generally unknown.</p>
<p>Substitutions are marked in a file using a block delimited by <code>{{</code> and <code>}}</code>. Inside the block the following variables are avalible:</p>
<ul>
<li><code>{{host}}</code> - the host name of the server exclusing any subdomain part.</li>
<li><code>{{domains[]}}</code> - the domain name of a particular subdomain e.g. <code>{{domains[www]}}</code> for the <code>www</code> subdomain.</li>
<li><code>{{ports[][]}}</code> - <a class="el" href="protocol_the-p.html">The</a> port number of servers, by protocol e.g. <code>{{ports[http][1]}}</code> for the second (i.e. non-default) http server.</li>
<li><code>{{headers[]}}</code> - <a class="el" href="protocol_the-p.html">The</a> HTTP headers in the request e.g. <code>{{headers[X-Test]}}</code> for a hypothetical <code>X-Test</code> header.</li>
<li><code>{{GET[]}}</code> - <a class="el" href="protocol_the-p.html">The</a> query parameters for the request e.g. <code>{{GET[id]}}</code> for an id parameter sent with the request.</li>
</ul>
<p>So, for example, to write a javascript file called <code>xhr.js</code> that does a cross domain XHR test to a different subdomain and port, one would write in the file: </p><pre class="fragment">var server_url = "http://{{domains[www]}}:{{ports[http][1]}}/path/to/resource";
//Create the actual XHR and so on
</pre><p><a class="el" href="protocol_the-p.html">The</a> file would then be included as: </p><pre class="fragment">&lt;script src="xhr.js?pipe=sub"&gt;&lt;/script&gt;
</pre><h3>status</h3>
<p>Used to set the HTTP status of the response, for example: </p><pre class="fragment">example.js?pipe=status(410)
</pre><h3>headers</h3>
<p>Used to add or replace http headers in the response. Takes two or three arguments; the header name, the header value and whether to append the header rather than replace an existing header (default: False). So, for example, a request for: </p><pre class="fragment">example.html?pipe=header(Content-Type,text/plain)
</pre><p>causes example.html to be returned with a text/plain content type whereas: </p><pre class="fragment">example.html?pipe=header(Content-Type,text/plain,True)
</pre><p>Will cause example.html to be returned with both text/html and text/plain content-type headers.</p>
<h3>slice</h3>
<p>Used to send only part of a response body. Takes the start and, optionally, end bytes as arguments, although either can be null to indicate the start or end of the file, respectively. So for example: </p><pre class="fragment">example.txt?pipe=slice(10,20)
</pre><p>Would result in a response with a body containing 10 bytes of example.txt including byte 10 but excluding byte 20. </p><pre class="fragment">example.txt?pipe=slice(10)
</pre><p>Would cause all bytes from byte 10 of example.txt to be sent, but: </p><pre class="fragment">example.txt?pipe=slice(null,20)
</pre><p>Would send the first 20 bytes of example.txt.</p>
<h3>trickle</h3>
<p>Used to send the body of a response in chunks with delays. Takes a single argument that is a microsyntax consisting of colon-separated commands. There are three types of commands:</p>
<ul>
<li>Bare numbers represent a number of bytes to send</li>
<li>Numbers prefixed <code>d</code> indicate a delay in seconds</li>
<li>Numbers prefixed <code>r</code> must only appear at the end of the command, and indicate that the preceding N items must be repeated until there is no more content to send.</li>
</ul>
<p>In the absence of a repetition command, the entire remainder of the content is sent at once when the command list is exhausted. So for example: </p><pre class="fragment">example.txt?pipe=trickle(d1)
</pre><p>causes a 1s delay before sending the entirety of example.txt. </p><pre class="fragment">example.txt?pipe=trickle(100:d1)
</pre><p>causes 100 bytes of example.txt to be sent, followed by a 1s delay, and then the remainder of the file to be sent. On the other hand: </p><pre class="fragment">example.txt?pipe=trickle(100:d1:r2)
</pre><p>Will cause the file to be sent in 100 byte chunks separated by a 1s delay until the whole content has been sent.</p>
<h2>asis files</h2>
<p>Suitable for:</p>
<ul>
<li>Static, HTTP-non-compliant responses</li>
</ul>
<p>asis files are simply files with the extension <code>.asis</code>. They are sent byte for byte to the server without adding a HTTP status line, headers, or anything else. This makes them suitable for testing situations where the precise bytes on the wire are static, and control over the timing is unnecessary, but the response does not conform to HTTP requirements.</p>
<h2>py files</h2>
<p>Suitable for:</p>
<ul>
<li>All tests requiring dynamic responses</li>
<li>Tests that need to store server side state.</li>
</ul>
<p><a class="el" href="protocol_the-p.html">The</a> most flexible mechanism for writing tests is to use <code>.py</code> files. These are interpreted as code and are suitable for the same kinds of tasks that one might achieve using cgi, PHP or a similar technology. Unlike cgi or PHP, the file is not executed directly and does not produce output by writing to <code>stdout</code>. Instead files must contain (at least) a function named <code>main</code>, with the signature: </p><pre class="fragment">def main(request, response):
    pass
</pre><p>Here <code>request</code> is a <code>Request</code> object that contains details of the request, and <code>response</code> is a <code>Response</code> object that can be used to set properties of the response. Full details of these objects is provided in the <a href="http://wptserve.readthedocs.org/en/latest/">wptserve documentation</a>.</p>
<p>In many cases tests will not need to work with the <code>response</code> object directly. Instead they can set the status, headers and body simply by returning values from the <code>main</code> function. If any value is returned, it is interpreted as the response body. If two values are returned they are interpreted as headers and body, and three values are interpreted as status, headers, body. So, for example: </p><pre class="fragment">def main(request, response):
    return "TEST"
</pre><p>creates a response with no non-default headers and the body <code>TEST</code>. Headers can be added as follows: </p><pre class="fragment">def main(request, response):
    return ([("Content-Type", "text/plain"), ("X-Test", "test")],
            "TEST")
</pre><p>And a status code as: </p><pre class="fragment">def main(request, response):
    return (410,
            [("Content-Type", "text/plain"), ("X-Test", "test")],
          "TEST")
</pre><p><a class="el" href="struct_a.html">A</a> custom status string may be returned by using a tuple <code>code, string</code> in place of the code alone.</p>
<p>At the other end of the scale, some tests require precision over the exact bytes sent over the wire and their timing. This can be achieved using the <code>writer</code> property of the response, which exposes a <code>ResponseWriter</code> object that allows wither writing specific parts of the request or direct access to the underlying socket.</p>
<p>For full documentation on the facilities available in <code>.py</code> files, see the <a href="http://wptserve.readthedocs.org/en/latest/">wptserve documentation</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
