<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>webkit: Fuzz testing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">webkit
   &#160;<span id="projectnumber">2cdf99a9e3038c7e01b3c37e8ad903ecbe5eecf1</span>
   </div>
   <div id="projectbrief">https://github.com/WebKit/webkit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Fuzz testing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Modern fuzz testers are very effective and we wish to use them to ensure that no silly bugs creep into BoringSSL.</p>
<p>We primarily use Clang's <a href="http://llvm.org/docs/LibFuzzer.html">libFuzzer</a> for fuzz testing and there are a number of fuzz testing functions in <code>fuzz/</code>. They are not built by default because they require libFuzzer at build time.</p>
<p>In order to build the fuzz tests you will need at least Clang 3.7. Pass <code>-DFUZZ=1</code> on the CMake command line to enable building BoringSSL with coverage and AddressSanitizer, and to build the fuzz test binaries. You'll probably need to set the <code>CC</code> and <code>CXX</code> environment variables too, like this:</p>
<div class="fragment"><div class="line">CC=clang CXX=clang++ cmake -GNinja -DFUZZ=1 ..</div></div><!-- fragment --><p>In order for the fuzz tests to link, the linker needs to find libFuzzer. This is not commonly provided and you may need to download the <a href="http://llvm.org/releases/download.html">Clang source code</a> and do the following:</p>
<div class="fragment"><div class="line">svn co http://llvm.org/svn/llvm-project/llvm/trunk/lib/Fuzzer</div><div class="line">clang++ -c -g -O2 -std=c++11 Fuzzer/*.cpp -IFuzzer</div><div class="line">ar ruv libFuzzer.a Fuzzer*.o</div></div><!-- fragment --><p>Then copy <code>libFuzzer.a</code> to the top-level of your BoringSSL source directory.</p>
<p>From the <code>build/</code> directory, you can then run the fuzzers. For example:</p>
<div class="fragment"><div class="line">./fuzz/cert -max_len=3072 -jobs=32 -workers=32 ../fuzz/cert_corpus/</div></div><!-- fragment --><p><a class="el" href="protocol_the-p.html">The</a> arguments to <code>jobs</code> and <code>workers</code> should be the number of cores that you wish to dedicate to fuzzing. By default, libFuzzer uses the largest test in the corpus (or 64 if empty) as the maximum test case length. <a class="el" href="protocol_the-p.html">The</a> <code>max_len</code> argument overrides this.</p>
<p><a class="el" href="protocol_the-p.html">The</a> recommended values of <code>max_len</code> for each test are:</p>
<table class="doxtable">
<tr>
<th><a class="el" href="struct_test.html">Test</a> </th><th><code>max_len</code> value  </th></tr>
<tr>
<td><code>cert</code> </td><td>3072 </td></tr>
<tr>
<td><code>client</code> </td><td>20000 </td></tr>
<tr>
<td><code>pkcs8</code> </td><td>2048 </td></tr>
<tr>
<td><code>privkey</code> </td><td>2048 </td></tr>
<tr>
<td><code>server</code> </td><td>4096 </td></tr>
<tr>
<td><code>spki</code> </td><td>1024 </td></tr>
<tr>
<td><code>read_pem</code> </td><td>512 </td></tr>
<tr>
<td><code>ssl_ctx_api</code> </td><td>256 </td></tr>
</table>
<p>These were determined by rounding up the length of the largest case in the corpus.</p>
<p>There are directories in <code>fuzz/</code> for each of the fuzzing tests which contain seed files for fuzzing. Some of the seed files were generated manually but many of them are “interesting” results generated by the fuzzing itself. (Where “interesting” means that it triggered a previously unknown path in the code.)</p>
<h2>Minimising the corpuses</h2>
<p>When a large number of new seeds are available, it's a good idea to minimise the corpus so that different seeds that trigger the same code paths can be deduplicated.</p>
<p>In order to minimise all the corpuses, build for fuzzing and run <code>./fuzz/minimise_corpuses.sh</code>. Note that minimisation is, oddly, often not idempotent for unknown reasons.</p>
<h2>Fuzzer mode</h2>
<p>When <code>-DFUZZ=1</code> is passed into CMake, BoringSSL builds with <code>BORINGSSL_UNSAFE_FUZZER_MODE</code> defined. This modifies the library, particularly the TLS stack, to be more friendly to fuzzers. It will:</p>
<ul>
<li>Replace <code>RAND_bytes</code> with a deterministic PRNG. Call <code>RAND_reset_for_fuzzing()</code> at the start of fuzzers which use <code>RAND_bytes</code> to reset the PRNG state.</li>
<li>Modify the TLS stack to perform all signature checks (CertificateVerify and ServerKeyExchange) and the Finished check, but always act as if the check succeeded.</li>
<li>Treat every cipher as the NULL cipher.</li>
<li>Use a hard-coded time instead of the actual time.</li>
<li>Tickets are unencrypted and the MAC check is performed but ignored.</li>
</ul>
<p>This is to prevent the fuzzer from getting stuck at a cryptographic invariant in the protocol.</p>
<h2>TLS transcripts</h2>
<p><a class="el" href="protocol_the-p.html">The</a> <code>client</code> and <code>server</code> corpora are seeded from the test suite. <a class="el" href="protocol_the-p.html">The</a> test suite has a <code>-fuzzer</code> flag which mirrors the fuzzer mode changes above and a <code>-deterministic</code> flag which removes all non-determinism on the Go side. Not all tests pass, so <code>ssl/test/runner/fuzzer_mode.json</code> contains the necessary suppressions. To run the tests against a fuzzer-mode <code>bssl_shim</code>, run:</p>
<div class="fragment"><div class="line">cd ssl/test/runner</div><div class="line">go test -fuzzer -deterministic -shim-config fuzzer_mode.json</div></div><!-- fragment --><p>For a different build directory from <code>build/</code>, pass the appropriate <code>-shim-path</code> flag. If those tests pass, record a set of transcripts with:</p>
<div class="fragment"><div class="line">go test -fuzzer -deterministic -transcript-dir /tmp/transcripts/</div></div><!-- fragment --><p>Note the suppressions file is ignored so disabled tests record transcripts too. Then merge into the existing corpora:</p>
<div class="fragment"><div class="line">cd build/</div><div class="line">./fuzz/client -max_len=50000 -merge=1 ../fuzz/client_corpus /tmp/transcripts/tls/client</div><div class="line">./fuzz/server -max_len=50000 -merge=1 ../fuzz/server_corpus /tmp/transcripts/tls/server</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
